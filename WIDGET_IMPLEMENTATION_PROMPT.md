# Widget Implementation Prompt for Uplinq Chat Widget

## üìã Task Overview

Update the Uplinq Chat Widget to fetch customization data (colors, logo, avatars) dynamically from the dashboard API instead of using hardcoded values. This enables real-time customization updates without changing the embed code.

---

## üéØ What Needs to Change

### Current Behavior (What We Assume)
- Widget accepts config in `mount()` function
- Widget uses static/default colors and branding
- Customization is passed directly in embed code

### Required Behavior (What We Need)
- Widget accepts `organizationId` and `apiBaseUrl` in config
- Widget fetches customization from API on mount
- Widget applies fetched customization (gradient, logo, avatars) to UI
- Widget gracefully falls back to defaults if API call fails

---

## üì° API Endpoint Details

### Endpoint
```
GET {apiBaseUrl}/api/chatbot/customization/{organizationId}
```

### Example
```
GET http://localhost:3000/api/chatbot/customization/cmixfcoka0001sbdt935dus65
```

### Response Format
```json
{
  "gradient": {
    "color1": "#1e5eff",
    "color2": "#5860f4",
    "color3": "#7c3aed",
    "color4": "#dcd6ff"
  },
  "avatars": ["https://example.com/avatar1.png", "https://example.com/avatar2.png"],
  "logo": "https://example.com/logo.png",
  "webhookUrl": "https://uplinq.app.n8n.cloud/webhook/chatbot-enterprise"
}
```

### Response Fields
- `gradient.color1` - First gradient color stop (top)
- `gradient.color2` - Second gradient color stop
- `gradient.color3` - Third gradient color stop (32% position)
- `gradient.color4` - Fourth gradient color stop (55% position)
- `avatars` - Array of avatar image URLs (max 3)
- `logo` - Logo image URL (can be null)
- `webhookUrl` - Webhook URL for chat functionality

### Error Handling
- If organization not found: 404 response
- If API unavailable: Network error
- **Fallback:** Use default colors/values if API fails

---

## üîß Embed Code Format

### Current Embed Code Structure
The embed code generated by the dashboard looks like this:

```html
<div id="uplinq-chat-root"></div>
<script>
(function() {
  const script = document.createElement('script');
  script.src = 'https://uplinq-chat-widget-bgyucpwf5-waynedevs-projects.vercel.app/uplinq-chat-widget.umd.js?v=1234567890';
  script.onload = function() {
    if (window.UplinqChatWidget) {
      window.UplinqChatWidget.mount('#uplinq-chat-root', {
        organizationId: 'cmixfcoka0001sbdt935dus65',
        webhookUrl: 'https://uplinq.app.n8n.cloud/webhook/chatbot-enterprise',
        apiBaseUrl: 'http://localhost:3000',
        initialOpen: true,
        hideButton: true
      });
    }
  };
  document.head.appendChild(script);
})();
</script>
```

### Config Parameters
- `organizationId` (required) - Organization ID to fetch customization for
- `webhookUrl` (required) - n8n webhook URL for chat functionality
- `apiBaseUrl` (required) - Base URL of dashboard API (e.g., `http://localhost:3000` or `https://your-dashboard.vercel.app`)
- `initialOpen` (optional) - Whether widget starts open
- `hideButton` (optional) - Whether to hide the floating button

---

## üíª Implementation Requirements

### 1. Update Mount Function Signature

The `mount()` function should accept:
```javascript
window.UplinqChatWidget.mount(containerSelector, config)
```

Where `config` includes:
```javascript
{
  organizationId: string,    // Required
  webhookUrl: string,        // Required
  apiBaseUrl: string,        // Required
  initialOpen?: boolean,     // Optional
  hideButton?: boolean,      // Optional
  // ... any other existing config options
}
```

### 2. Fetch Customization Function

Create a function to fetch customization from API:

```javascript
async function fetchCustomization(organizationId, apiBaseUrl) {
  try {
    const response = await fetch(
      `${apiBaseUrl.replace(/\/$/, '')}/api/chatbot/customization/${organizationId}`
    );
    
    if (!response.ok) {
      throw new Error(`API returned ${response.status}`);
    }
    
    const data = await response.json();
    return data;
  } catch (error) {
    console.warn('Failed to fetch customization, using defaults:', error);
    return null; // Return null to use defaults
  }
}
```

### 3. Apply Customization to UI

Create functions to apply customization:

```javascript
function applyGradient(container, gradient) {
  // Apply gradient to widget background
  // Gradient format: linear-gradient(180deg, color1, color2, color3 32%, color4 55%, #fff 72%, ...)
  const gradientStyle = `linear-gradient(180deg, 
    ${gradient.color1}, 
    ${gradient.color2}, 
    ${gradient.color3} 32%, 
    ${gradient.color4} 55%, 
    #fff 72%, 
    #fff, 
    #fff
  )`;
  
  // Apply to widget scroll area or main container
  const scrollArea = container.querySelector('.chat-scroll');
  if (scrollArea) {
    scrollArea.style.background = gradientStyle;
  }
}

function applyLogo(container, logoUrl) {
  if (!logoUrl) return;
  
  const logoElement = container.querySelector('[data-logo], .logo, .brand-logo');
  if (logoElement) {
    const img = logoElement.tagName === 'IMG' 
      ? logoElement 
      : logoElement.querySelector('img');
    if (img) {
      img.src = logoUrl;
      img.style.display = '';
    }
  }
}

function applyAvatars(container, avatars) {
  if (!avatars || avatars.length === 0) return;
  
  const avatarElements = container.querySelectorAll('[data-avatar], .avatar-img, .user-avatar');
  avatarElements.forEach((element, index) => {
    if (index < avatars.length && avatars[index]) {
      const img = element.tagName === 'IMG' 
        ? element 
        : element.querySelector('img');
      if (img) {
        img.src = avatars[index];
      }
    }
  });
}
```

### 4. Update Mount Function

Modify your mount function to:
1. Extract `organizationId` and `apiBaseUrl` from config
2. Fetch customization asynchronously
3. Apply customization when received
4. Fall back to defaults if fetch fails

```javascript
window.UplinqChatWidget = {
  async mount(containerSelector, config) {
    const container = document.querySelector(containerSelector);
    if (!container) {
      console.error(`Container not found: ${containerSelector}`);
      return;
    }

    const { organizationId, apiBaseUrl, webhookUrl, ...otherConfig } = config;

    // Validate required parameters
    if (!organizationId || !apiBaseUrl || !webhookUrl) {
      console.error('Missing required config: organizationId, apiBaseUrl, or webhookUrl');
      return;
    }

    // Default customization values
    const defaultCustomization = {
      gradient: {
        color1: '#1e5eff',
        color2: '#5860f4',
        color3: '#7c3aed',
        color4: '#dcd6ff'
      },
      avatars: [],
      logo: null,
      webhookUrl: webhookUrl
    };

    // Fetch customization from API
    let customization = await fetchCustomization(organizationId, apiBaseUrl);
    
    // Use defaults if fetch failed
    if (!customization) {
      customization = defaultCustomization;
    } else {
      // Merge with defaults to ensure all fields exist
      customization = {
        ...defaultCustomization,
        ...customization,
        gradient: {
          ...defaultCustomization.gradient,
          ...customization.gradient
        }
      };
    }

    // Initialize widget with customization
    initializeWidget(container, {
      ...otherConfig,
      webhookUrl: customization.webhookUrl || webhookUrl,
      customization: {
        gradient: customization.gradient,
        avatars: customization.avatars,
        logo: customization.logo
      }
    });

    // Apply customization to UI
    applyGradient(container, customization.gradient);
    applyLogo(container, customization.logo);
    applyAvatars(container, customization.avatars);
  }
};
```

---

## üé® CSS/Stlying Requirements

### Gradient Application
The gradient should be applied to the chat scroll area with this specific format:
```css
.chat-scroll {
  background: linear-gradient(180deg, 
    color1, 
    color2, 
    color3 32%, 
    color4 55%, 
    #fff 72%, 
    #fff, 
    #fff
  ) !important;
}
```

### Selector Priority
Use data attributes for reliable element selection:
- Logo: `[data-logo]` or `.logo` or `.brand-logo`
- Avatars: `[data-avatar]` or `.avatar-img` or `.user-avatar`
- Scroll area: `.chat-scroll` or `[data-scroll-area]`

---

## ‚úÖ Testing Requirements

### Test Cases

1. **Successful Customization Fetch**
   - Widget fetches customization from API
   - Applies gradient colors correctly
   - Applies logo if provided
   - Applies avatars if provided

2. **API Failure Handling**
   - Widget falls back to default colors
   - Widget continues to function normally
   - No errors break the widget

3. **Missing Fields**
   - Widget handles missing logo gracefully
   - Widget handles empty avatars array
   - Widget uses defaults for missing gradient colors

4. **Different Organizations**
   - Widget fetches different customization per organization
   - Widget applies correct customization for each org

### Test Page
A test HTML page is available at:
```
http://localhost:3000/test-chatbot.html
```

Or in the dashboard repo: `/test-chatbot.html`

### Test Configuration
```javascript
{
  organizationId: 'cmixfcoka0001sbdt935dus65',
  apiBaseUrl: 'http://localhost:3000',
  webhookUrl: 'https://uplinq.app.n8n.cloud/webhook/chatbot-enterprise'
}
```

---

## üìù Implementation Checklist

- [ ] Update `mount()` function to accept `organizationId` and `apiBaseUrl`
- [ ] Create `fetchCustomization()` function
- [ ] Create `applyGradient()` function
- [ ] Create `applyLogo()` function
- [ ] Create `applyAvatars()` function
- [ ] Update mount function to fetch and apply customization
- [ ] Add error handling and fallback to defaults
- [ ] Test with valid organization ID
- [ ] Test with invalid organization ID (should use defaults)
- [ ] Test with API unavailable (should use defaults)
- [ ] Test gradient application
- [ ] Test logo application (with and without logo)
- [ ] Test avatars application (with and without avatars)
- [ ] Verify widget still works if customization API fails
- [ ] Test with multiple different organizations

---

## üîç Current Widget Structure (What We Assume)

If your widget structure is different, adapt these selectors/patterns:

### Common Patterns
- Widget container: `#uplinq-chat-root` or configurable selector
- Scroll area: `.chat-scroll` or similar
- Header: `.chat-header` or similar
- Logo location: Header area
- Avatars location: Header area, near logo

### DOM Structure Assumption
```html
<div id="uplinq-chat-root">
  <div class="chat-widget">
    <header class="chat-header">
      <img class="logo" data-logo />
      <div class="avatars">
        <img class="avatar" data-avatar />
        <img class="avatar" data-avatar />
        <img class="avatar" data-avatar />
      </div>
    </header>
    <div class="chat-scroll">
      <!-- Messages area -->
    </div>
  </div>
</div>
```

---

## üìû API Details

### CORS
The API endpoint has CORS enabled:
- `Access-Control-Allow-Origin: *`
- `Access-Control-Allow-Methods: GET, OPTIONS`

### Caching
API responses are cached for 60 seconds:
- `Cache-Control: public, max-age=60`

### Error Responses
- `400`: Missing organizationId
- `404`: Organization not found
- `500`: Server error

---

## üöÄ Expected Outcome

After implementation:
1. Admin generates embed code with `organizationId` and `apiBaseUrl`
2. Client adds embed code to their website
3. Widget loads and fetches customization from API
4. Widget applies customization (colors, logo, avatars)
5. Client customizes in dashboard and clicks "Publish"
6. Widget automatically uses new customization (on refresh or cache expiry)

**No embed code changes needed after initial setup!**

---

## ‚ùì Questions/Clarifications

If your widget structure differs significantly:
1. What selectors/elements do you use for logo, avatars, scroll area?
2. How is the widget currently styled (CSS classes, inline styles)?
3. What's the current mount function signature?
4. Are there any existing customization mechanisms?

---

## üìö Summary for AI/Developer

**TL;DR:** 
- Update widget to accept `organizationId` and `apiBaseUrl` in config
- Fetch customization from `${apiBaseUrl}/api/chatbot/customization/${organizationId}`
- Apply gradient to scroll area, logo to header, avatars to header
- Fall back to defaults if API fails
- Ensure widget works even if API is unavailable

**Key Point:** The customization is now fetched dynamically from the API, not passed in embed code. This allows real-time updates without changing embed code on client websites.





